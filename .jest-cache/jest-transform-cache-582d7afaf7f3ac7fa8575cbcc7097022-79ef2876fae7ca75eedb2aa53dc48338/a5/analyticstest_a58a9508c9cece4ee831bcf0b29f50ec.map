{"version":3,"sources":["C:\\repos\\family-oriented\\src\\utils\\__tests__\\analytics.test.ts"],"sourcesContent":["/**\r\n * Enhanced Analytics Service Tests\r\n * Updated with timeout protection, error boundary testing, and performance validation\r\n */\r\n\r\nimport { analyticsService } from '../analyticsService';\r\n\r\n// Test timeout constants\r\nconst TEST_TIMEOUTS = {\r\n  FAST: 2000,\r\n  MEDIUM: 5000,\r\n  SLOW: 8000\r\n} as const;\r\n\r\n// Mock data constants\r\nconst MOCK_DATA = {\r\n  sessionId: 'mock-session-id',\r\n  metrics: {\r\n    totalGamesPlayed: 1,\r\n    averageSessionDuration: 60,\r\n    overallCompletionRate: 1,\r\n    skillLevelDistribution: { beginner: 1 },\r\n    subjectPreferences: { Mathematics: 1 },\r\n    learningVelocity: 1,\r\n    engagementScore: 80\r\n  },\r\n  recommendations: [\r\n    { gameId: 'letters', reason: 'Try letters next!', priority: 8, estimatedDifficulty: 'beginner', learningObjectives: [], prerequisitesMet: true }\r\n  ],\r\n  analytics: {\r\n    totalSessions: 1,\r\n    uniquePlayers: 1,\r\n    averageDuration: 60,\r\n    completionRate: 1,\r\n    popularGames: [],\r\n    learningEffectiveness: {}\r\n  }\r\n} as const;\r\n\r\n// Mock all async Supabase calls with proper implementations\r\nbeforeAll(() => {\r\n  jest.spyOn(analyticsService, 'startGameSession').mockImplementation(async () => MOCK_DATA.sessionId);\r\n  jest.spyOn(analyticsService, 'trackEvent').mockImplementation(async () => undefined);\r\n  jest.spyOn(analyticsService, 'completeGameSession').mockImplementation(async () => undefined);\r\n  jest.spyOn(analyticsService, 'getPerformanceMetrics').mockImplementation(async () => MOCK_DATA.metrics);\r\n  jest.spyOn(analyticsService, 'getLearningPathRecommendations').mockImplementation(async () => MOCK_DATA.recommendations);\r\n  jest.spyOn(analyticsService, 'getAggregateAnalytics').mockImplementation(async () => MOCK_DATA.analytics);\r\n});\r\n\r\ndescribe('Analytics Service - Enhanced Validation', () => {\r\n  const testAvatarId = '00000000-0000-0000-0000-000000000005';\r\n  const testGameId = 'numbers' as const;\r\n  const testSettings = { difficulty: 'easy', questionsPerSession: 5 };\r\n\r\n  // Enhanced setup and cleanup\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  afterEach(() => {\r\n    jest.resetAllMocks();\r\n  });\r\n\r\n  describe('Session Management', () => {\r\n    test('should start a game session with timeout protection', async () => {\r\n      const startTime = performance.now();\r\n      \r\n      const sessionPromise = analyticsService.startGameSession(\r\n        testAvatarId, \r\n        testGameId, \r\n        testSettings\r\n      );\r\n      \r\n      // Add timeout protection using Promise.race\r\n      const sessionId = await Promise.race([\r\n        sessionPromise,\r\n        new Promise<never>((_, reject) => \r\n          setTimeout(() => reject(new Error('Session start timeout')), TEST_TIMEOUTS.FAST)\r\n        )\r\n      ]);\r\n      \r\n      const executionTime = performance.now() - startTime;\r\n      \r\n      expect(sessionId).toBeDefined();\r\n      expect(typeof sessionId).toBe('string');\r\n      expect(sessionId.length).toBeGreaterThan(0);\r\n      expect(executionTime).toBeLessThan(1000); // Performance check\r\n    }, TEST_TIMEOUTS.MEDIUM);\r\n\r\n    test('should track events without errors', async () => {\r\n      const sessionId = await analyticsService.startGameSession(\r\n        testAvatarId, \r\n        testGameId, \r\n        testSettings\r\n      );\r\n      \r\n      // Test each call individually without using .resolves\r\n      const result1 = await analyticsService.trackEvent(sessionId, testAvatarId, 'question_start', {});\r\n      expect(result1).toBeUndefined();\r\n      \r\n      const result2 = await analyticsService.trackEvent(sessionId, testAvatarId, 'question_answer', { correct: true });\r\n      expect(result2).toBeUndefined();\r\n      \r\n      const result3 = await analyticsService.trackEvent(sessionId, testAvatarId, 'game_pause', {});\r\n      expect(result3).toBeUndefined();\r\n    });\r\n\r\n    test('should complete session and generate metrics', async () => {\r\n      const sessionId = await analyticsService.startGameSession(\r\n        testAvatarId, \r\n        testGameId, \r\n        testSettings\r\n      );\r\n      await analyticsService.trackEvent(sessionId, testAvatarId, 'question_answer', { correct: true });\r\n      await analyticsService.trackEvent(sessionId, testAvatarId, 'question_answer', { correct: false });\r\n      \r\n      const result = await analyticsService.completeGameSession(sessionId, 75, 2, 1);\r\n      expect(result).toBeUndefined();\r\n    });\r\n\r\n    test('should generate performance metrics', async () => {\r\n      const metrics = await analyticsService.getPerformanceMetrics(testAvatarId);\r\n      expect(metrics).toBeDefined();\r\n      expect(typeof metrics.totalGamesPlayed).toBe('number');\r\n      expect(typeof metrics.averageSessionDuration).toBe('number');\r\n      expect(typeof metrics.overallCompletionRate).toBe('number');\r\n      expect(typeof metrics.engagementScore).toBe('number');\r\n    });\r\n\r\n    test('should generate learning path recommendations', async () => {\r\n      const recommendations = await analyticsService.getLearningPathRecommendations(testAvatarId, 3);\r\n      expect(Array.isArray(recommendations)).toBe(true);\r\n      expect(recommendations.length).toBeLessThanOrEqual(3);\r\n      recommendations.forEach(rec => {\r\n        expect(rec).toHaveProperty('gameId');\r\n        expect(rec).toHaveProperty('reason');\r\n        expect(rec).toHaveProperty('priority');\r\n        expect(typeof rec.priority).toBe('number');\r\n        expect(rec.priority).toBeGreaterThanOrEqual(1);\r\n        expect(rec.priority).toBeLessThanOrEqual(10);\r\n      });\r\n    });\r\n\r\n    test('should generate aggregate analytics', async () => {\r\n      const analytics = await analyticsService.getAggregateAnalytics();\r\n      expect(analytics).toBeDefined();\r\n      expect(typeof analytics.totalSessions).toBe('number');\r\n      expect(typeof analytics.uniquePlayers).toBe('number');\r\n      expect(typeof analytics.averageDuration).toBe('number');\r\n      expect(typeof analytics.completionRate).toBe('number');\r\n      expect(Array.isArray(analytics.popularGames)).toBe(true);\r\n    });\r\n  });\r\n});"],"names":["TEST_TIMEOUTS","FAST","MEDIUM","SLOW","MOCK_DATA","sessionId","metrics","totalGamesPlayed","averageSessionDuration","overallCompletionRate","skillLevelDistribution","beginner","subjectPreferences","Mathematics","learningVelocity","engagementScore","recommendations","gameId","reason","priority","estimatedDifficulty","learningObjectives","prerequisitesMet","analytics","totalSessions","uniquePlayers","averageDuration","completionRate","popularGames","learningEffectiveness","beforeAll","jest","spyOn","analyticsService","mockImplementation","undefined","describe","testAvatarId","testGameId","testSettings","difficulty","questionsPerSession","beforeEach","clearAllMocks","afterEach","resetAllMocks","test","startTime","performance","now","sessionPromise","startGameSession","Promise","race","_","reject","setTimeout","Error","executionTime","expect","toBeDefined","toBe","length","toBeGreaterThan","toBeLessThan","result1","trackEvent","toBeUndefined","result2","correct","result3","result","completeGameSession","getPerformanceMetrics","getLearningPathRecommendations","Array","isArray","toBeLessThanOrEqual","forEach","rec","toHaveProperty","toBeGreaterThanOrEqual","getAggregateAnalytics"],"mappings":"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"}